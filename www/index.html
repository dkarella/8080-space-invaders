<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Space Invaders Emulator</title>
</head>

<body>
	<canvas id="canvas"></canvas>
	<div id="welcome">
		<input type="file" id="invader-files" multiple>
		<button onclick="start()">start</button>
	</div>
	<script type="text/javascript">
		function getFileData() {
			return new Promise((resolve, reject) => {
				const files = [...document.getElementById('invader-files').files];
				files.sort((f1, f2) => -f1.name.localeCompare(f2.name, 'en'));

				const fr = new FileReader();
				fr.onload = () => {
					resolve(new Uint8Array(fr.result));
				};
				fr.onerror = () => {
					reject(fr.error);
				};

				fr.readAsArrayBuffer(new Blob(files));
			});
		}


		async function start() {
			const canvas = document.getElementById('canvas');
			const welcome = document.getElementById('welcome');

			const data = await getFileData();

			import('/main.mjs')
				.then(({ default: instantiate }) => {
					return instantiate({
						print: console.log,
						canvas,
					});
				})
				.then(async Module => {
					Module.FS_createPath('/res', 'rom', true, false);
					Module.FS_createDataFile('/res/rom', 'invaders', data, true, false, false);
					let err = Module.ccall('start', null, [], []);
					if (err) {
						// TODO display error message
						return;
					}

					welcome.style.display = 'none';
				});
		}


	</script>

</body>

</html>